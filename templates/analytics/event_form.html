{% extends "base.html" %}
{% load static %}

{% block title %}New Event{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow-sm">
            <div class="card-header bg-primary text-white">
                <h2 class="mb-0">
                    <i class="bi bi-calendar-event me-2"></i>New Event
                </h2>
            </div>
            <div class="card-body p-4">
                <form method="post" id="eventForm">
                    {% csrf_token %}

                    <div class="row">
                        <!-- Left Column -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label fw-bold">
                                    <i class="bi bi-pencil me-1"></i>Title
                                </label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="text-danger small">{{ form.title.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.event_type.id_for_label }}" class="form-label fw-bold">
                                    <i class="bi bi-tag me-1"></i>Event Type
                                </label>
                                {{ form.event_type }}
                                {% if form.event_type.errors %}
                                    <div class="text-danger small">{{ form.event_type.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.project.id_for_label }}" class="form-label fw-bold">
                                    <i class="bi bi-folder me-1"></i>Project
                                </label>
                                {{ form.project }}
                                {% if form.project.errors %}
                                    <div class="text-danger small">{{ form.project.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-chat-left-text me-1"></i>Description
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="text-danger small">{{ form.description.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Right Column - Timer Section -->
                        <div class="col-md-6">
                            <div class="card bg-light mb-3">
                                <div class="card-body">
                                    <h5 class="card-title text-center mb-3">
                                        <i class="bi bi-stopwatch me-2"></i>Timer
                                    </h5>

                                    <div class="text-center mb-3">
                                        <div id="timerDisplay" class="display-3 fw-bold text-primary mb-3">00:00:00</div>
                                        <div class="btn-group" role="group">
                                            <button type="button" id="startBtn" class="btn btn-success btn-lg">
                                                <i class="bi bi-play-fill me-1"></i>Start
                                            </button>
                                            <button type="button" id="pauseBtn" class="btn btn-warning btn-lg" disabled>
                                                <i class="bi bi-pause-fill me-1"></i>Pause
                                            </button>
                                            <button type="button" id="stopBtn" class="btn btn-danger btn-lg" disabled>
                                                <i class="bi bi-stop-fill me-1"></i>Stop
                                            </button>
                                        </div>
                                    </div>

                                    <div class="mb-2">
                                        <label for="{{ form.start_time.id_for_label }}" class="form-label fw-bold small">
                                            <i class="bi bi-clock me-1"></i>Start Time
                                        </label>
                                        {{ form.start_time }}
                                        {% if form.start_time.errors %}
                                            <div class="text-danger small">{{ form.start_time.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="mb-2">
                                        <label for="{{ form.end_time.id_for_label }}" class="form-label fw-bold small">
                                            <i class="bi bi-clock-history me-1"></i>End Time
                                        </label>
                                        {{ form.end_time }}
                                        {% if form.end_time.errors %}
                                            <div class="text-danger small">{{ form.end_time.errors }}</div>
                                        {% endif %}
                                    </div>

                                    <div class="alert alert-info small mb-0" role="alert">
                                        <i class="bi bi-info-circle me-1"></i>
                                        Use the timer or manually enter times
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Full Width Fields -->
                    <div class="row">
                        <div class="col-12">
                            <div class="mb-3">
                                <label for="{{ form.tags.id_for_label }}" class="form-label fw-bold">
                                    <i class="bi bi-tags me-1"></i>Tags
                                    <small class="text-muted">(JSON array format: ["tag1", "tag2"])</small>
                                </label>
                                {{ form.tags }}
                                {% if form.tags.errors %}
                                    <div class="text-danger small">{{ form.tags.errors }}</div>
                                {% endif %}
                            </div>

                            <div class="mb-3">
                                <label for="{{ form.metadata.id_for_label }}" class="form-label fw-bold">
                                    <i class="bi bi-code-square me-1"></i>Metadata
                                    <small class="text-muted">(JSON object format)</small>
                                </label>
                                {{ form.metadata }}
                                {% if form.metadata.errors %}
                                    <div class="text-danger small">{{ form.metadata.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center">
                        <a href="{% url 'analytics:event_list' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-x-circle me-1"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg px-5">
                            <i class="bi bi-save me-1"></i>Save Event
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
    .form-control, .form-select {
        border-radius: 0.375rem;
        border: 1px solid #ced4da;
    }
    .form-control:focus, .form-select:focus {
        border-color: #86b7fe;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    #timerDisplay {
        font-family: 'Courier New', monospace;
        letter-spacing: 0.1em;
    }
    textarea.form-control {
        min-height: 100px;
    }
    .card-header h2 {
        font-size: 1.5rem;
    }
</style>

<script>
    let timerInterval = null;
    let startTime = null;
    let elapsedTime = 0;
    let isPaused = false;

    const startBtn = document.getElementById('startBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const stopBtn = document.getElementById('stopBtn');
    const timerDisplay = document.getElementById('timerDisplay');
    const startTimeInput = document.getElementById('{{ form.start_time.id_for_label }}');
    const endTimeInput = document.getElementById('{{ form.end_time.id_for_label }}');

    function formatTime(milliseconds) {
        const totalSeconds = Math.floor(milliseconds / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
    }

    function formatDateTimeLocal(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    function updateTimer() {
        if (!isPaused) {
            const currentTime = Date.now();
            elapsedTime = currentTime - startTime;
        }
        timerDisplay.textContent = formatTime(elapsedTime);
    }

    startBtn.addEventListener('click', function() {
        if (!startTime) {
            // First start
            startTime = Date.now() - elapsedTime;
            const now = new Date();
            startTimeInput.value = formatDateTimeLocal(now);
        } else {
            // Resume from pause
            startTime = Date.now() - elapsedTime;
        }

        isPaused = false;
        timerInterval = setInterval(updateTimer, 100);

        startBtn.disabled = true;
        pauseBtn.disabled = false;
        stopBtn.disabled = false;
        startBtn.innerHTML = '<i class="bi bi-play-fill me-1"></i>Resume';
    });

    pauseBtn.addEventListener('click', function() {
        isPaused = true;
        clearInterval(timerInterval);

        startBtn.disabled = false;
        pauseBtn.disabled = true;
    });

    stopBtn.addEventListener('click', function() {
        clearInterval(timerInterval);

        const now = new Date();
        endTimeInput.value = formatDateTimeLocal(now);

        // Reset
        elapsedTime = 0;
        startTime = null;
        isPaused = false;
        timerDisplay.textContent = formatTime(0);

        startBtn.disabled = false;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
        startBtn.innerHTML = '<i class="bi bi-play-fill me-1"></i>Start';
    });

    // Form submission validation
    document.getElementById('eventForm').addEventListener('submit', function(e) {
        if (timerInterval) {
            if (!confirm('Timer is still running. Stop timer and save event?')) {
                e.preventDefault();
                return;
            }
            stopBtn.click();
        }
    });
</script>
{% endblock %}